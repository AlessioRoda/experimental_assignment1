<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scripts.state_machine &mdash; Third_assignment 1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Third_assignment
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Third_assignment</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>scripts.state_machine</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for scripts.state_machine</h1><div class="highlight"><pre>
<span></span><span class="ch">#! /usr/bin/env python3</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">.. module:: state_machine</span>
<span class="sd">   :platform: Unix</span>
<span class="sd">   :synopsis: Node implementing a finite state machine that represents the steps of the Cluedo game</span>
<span class="sd">	</span>
<span class="sd">.. moduleauthor:: Alessio Roda alessioroda98@gmail.com</span>

<span class="sd">This node allows to simulate the Cluedo game </span>

<span class="sd">Subscriber:</span>
<span class="sd">    /marker_id custom service to get the ID of a marker when it&#39;s detected by the camera</span>

<span class="sd">Client: </span>
<span class="sd">    /oracle_hint custom service to ask the hint (ID, type and message) associated to a specific marker ID </span>
<span class="sd">    /ontology_interface/add_hint service to send a new hint to the oracle_interface node </span>
<span class="sd">    /ontology_interface/update_request service to send the request to the oracle_interface node for updating the ontology by adding the hints to the ontology and by performing the &quot;REASON&quot; command</span>
<span class="sd">    /ontology_interface/check_consistency service to send a request to the oracle_interface to find the complete and consistent hypothesis in the ontology</span>
<span class="sd">    /oracle_solution service asks to the final_module node to send the solution ID of the Cluedo game</span>
<span class="sd">    /ontology_interface/ask_solution to query the place, the person and the weapon corresponding to a certain ID</span>

<span class="sd">ActionClient:</span>
<span class="sd">    movebase to move to a specific position  </span>

<span class="sd"> It&#39;s performed as the node that permits to simulate the entire Cluedo game, it&#39;s the main of the whole architecture and with the smach </span>
<span class="sd"> StateMachine can simulate the game by switching from three states:</span>
<span class="sd"> </span>
<span class="sd"> -MOVE: It&#39;s defined by the Explore class and performs the motion of the robot from a room to another by using the move_base action service. Each time the MOVE state is executed, </span>
<span class="sd">        it checks if the robot must go to the Oracle Room (oracle==True) or in one of the other rooms: in this case all the rooms (that are defined as</span>
<span class="sd">        Place objects, with their name and coordinates) are stored in a list and, each time the robot moves, it reaches the last element in the list.</span>
<span class="sd"> </span>
<span class="sd"> -CHECK_CONSISTENCY: It&#39;s defined by the Check_Consistency class, in this state all the aruco IDs that are received from the topic /marker_id and haven&#39;t already </span>
<span class="sd">                    been checked are sent via the /oracle_hint to receive the corresponding hint; then the new hints are stored in the ontology_interface node via /ontology_interface/add_hint service. </span>
<span class="sd">                    After having stored all the hints, the ontology is updated with the new hints, by calling the service /ontology_interface/update_request; then it also asks for all the complete </span>
<span class="sd">                    and consistent hypothesis in the ontology calling /ontology_interface/check_consistency service and removes inconsistent hypothesis. If there are complete and consistent hypothesis the robot moves to the Oracle Room </span>
<span class="sd">                    (oracle set to True), otherwise it will move to another room (oracle is kept to False value).</span>
<span class="sd"> </span>
<span class="sd"> -SOLUTION: the state that represents the moment in which the robot is trying to generate a solution for the Cluedo game. It&#39;s defined with</span>
<span class="sd">            the Try_Solution class and during its execution checks if one of the complete and consistent IDs corresponds to the solution of the game, that is obtained via /oracle_solution service.</span>
<span class="sd">            If the solution is found, it asks the place, the person and the weapon corresponding to the solution ID and the simulation ends, otherwise the robot returns in the MOVE state.           </span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">from</span> <span class="nn">move_base_msgs.msg</span> <span class="kn">import</span> <span class="n">MoveBaseAction</span><span class="p">,</span> <span class="n">MoveBaseGoal</span>
<span class="kn">import</span> <span class="nn">smach</span>
<span class="kn">import</span> <span class="nn">smach_ros</span>
<span class="kn">from</span> <span class="nn">classes.place</span> <span class="kn">import</span> <span class="n">Place</span>
<span class="kn">import</span> <span class="nn">actionlib</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">Int32</span>
<span class="kn">from</span> <span class="nn">erl2.msg</span> <span class="kn">import</span> <span class="n">ErlOracle</span>
<span class="kn">from</span> <span class="nn">erl2.srv</span> <span class="kn">import</span> <span class="n">MarkerRequest</span><span class="p">,</span> <span class="n">Marker</span><span class="p">,</span> <span class="n">Hint</span><span class="p">,</span> <span class="n">HintRequest</span><span class="p">,</span> <span class="n">Consistent</span><span class="p">,</span> <span class="n">ConsistentRequest</span><span class="p">,</span> <span class="n">Update</span><span class="p">,</span> <span class="n">Oracle</span><span class="p">,</span> <span class="n">OracleRequest</span><span class="p">,</span> <span class="n">Solution</span><span class="p">,</span> <span class="n">SolutionRequest</span>


<span class="n">pub_move_base</span><span class="o">=</span><span class="kc">None</span>
<span class="sd">&#39;&#39;&#39; Initialize the action client for performing the motion of the robot via move_base action </span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">sub_ID</span><span class="o">=</span><span class="kc">None</span>
<span class="sd">&#39;&#39;&#39; Subscriber to /marker_id topic</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">client_ID_msg</span><span class="o">=</span><span class="kc">None</span>
<span class="sd">&#39;&#39;&#39; Initialize the /oracle_hint service client</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">client_add_hint</span><span class="o">=</span><span class="kc">None</span>
<span class="sd">&#39;&#39;&#39; Initialize the /ontology_interface/add_hint service client</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">client_update_ontology</span><span class="o">=</span><span class="kc">None</span>
<span class="sd">&#39;&#39;&#39; Initialize the /ontology_interface/update_request service client</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">client_try_solution</span><span class="o">=</span><span class="kc">None</span>
<span class="sd">&#39;&#39;&#39; Initialize the /ontology_interface/check_consistency service client</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">ask_solution</span><span class="o">=</span><span class="kc">None</span>
<span class="sd">&#39;&#39;&#39; Initialize the /oracle_solution service client</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">armor_solution</span><span class="o">=</span><span class="kc">None</span>
<span class="sd">&#39;&#39;&#39; Initialize the /ontology_interface/ask_solution service client</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="n">IDs</span><span class="o">=</span><span class="p">[]</span>
<span class="sd">&#39;&#39;&#39; list: List with the new IDs that are received</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">tried_IDs</span><span class="o">=</span><span class="p">[]</span>
<span class="sd">&#39;&#39;&#39; list: List with the IDs that have already been included in the ontology</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">consistent_ids</span><span class="o">=</span><span class="p">[]</span>
<span class="sd">&#39;&#39;&#39; list: List with the consistent_ids that have been found</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="n">places</span><span class="o">=</span><span class="p">[]</span>
<span class="sd">&#39;&#39;&#39; list: List with the places of the scene</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">actual_pose</span><span class="o">=</span><span class="kc">None</span>
<span class="sd">&#39;&#39;&#39; Actual position of the robot in the environment</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">oracle</span><span class="o">=</span><span class="kc">False</span>
<span class="sd">&#39;&#39;&#39; bool: Boolean to know if the robot must go to the Oracle_Room</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">oracle_room</span><span class="o">=</span><span class="kc">None</span>
<span class="sd">&#39;&#39;&#39; Initialize the Oracle_Room</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="n">stop</span><span class="o">=</span><span class="kc">False</span>
<span class="sd">&#39;&#39;&#39; bool: Flag to stop storing new IDs in the IDs list</span>

<span class="sd">&#39;&#39;&#39;</span>

<div class="viewcode-block" id="IDs_callback"><a class="viewcode-back" href="../../index.html#scripts.state_machine.IDs_callback">[docs]</a><span class="k">def</span> <span class="nf">IDs_callback</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Callback to get the IDs of the marker that have been detected by the aruco_ros node</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">global</span> <span class="n">IDs</span>
    <span class="k">if</span> <span class="nb">id</span><span class="o">.</span><span class="n">data</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IDs</span> <span class="ow">and</span> <span class="n">stop</span><span class="o">==</span><span class="kc">False</span> <span class="ow">and</span> <span class="nb">id</span><span class="o">.</span><span class="n">data</span><span class="o">&lt;=</span><span class="mi">40</span><span class="p">:</span>
        <span class="n">IDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="init_scene"><a class="viewcode-back" href="../../index.html#scripts.state_machine.init_scene">[docs]</a><span class="k">def</span> <span class="nf">init_scene</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to initialize the scenario with the rooms of the simulation</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">global</span> <span class="n">places</span><span class="p">,</span> <span class="n">actual_pose</span><span class="p">,</span> <span class="n">oracle_room</span>
    <span class="n">places</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Place</span><span class="p">(</span><span class="s1">&#39;ROOM1&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">places</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Place</span><span class="p">(</span><span class="s1">&#39;ROOM2&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">places</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Place</span><span class="p">(</span><span class="s1">&#39;ROOM3&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">places</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Place</span><span class="p">(</span><span class="s1">&#39;ROOM4&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">))</span>
    <span class="n">places</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Place</span><span class="p">(</span><span class="s1">&#39;ROOM5&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">places</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Place</span><span class="p">(</span><span class="s1">&#39;ROOM6&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">oracle_room</span><span class="o">=</span><span class="n">Place</span><span class="p">(</span><span class="s1">&#39;Oracle_Room&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">actual_pose</span><span class="o">=</span><span class="n">Place</span><span class="p">(</span><span class="s1">&#39;Oracle_Room&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#Starts in the oracle room</span></div>



<div class="viewcode-block" id="Explore"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Explore">[docs]</a><span class="k">class</span> <span class="nc">Explore</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A class to represent the behavior of the robot when it moves from a place to another</span>

<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;check_consistency&#39;</span><span class="p">,</span> <span class="s1">&#39;solution&#39;</span><span class="p">])</span>
        
<div class="viewcode-block" id="Explore.execute"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Explore.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Description of the execute method:</span>
<span class="sd">        It generates a move_base action goal with the coordinates of the last room in the list or, </span>
<span class="sd">        in case a possible solution is found (oracle==True), the coordinates of the Oracle Room, then sends it and waits until </span>
<span class="sd">        the target is reached.</span>

<span class="sd">            Args:</span>
<span class="sd">                userdata to store the variables between the states</span>
<span class="sd">            Returns:</span>
<span class="sd">                &#39;solution&#39;(string): if it must go to the SOLUTION state</span>
<span class="sd">                &#39;enter_room&#39;(string): if it must go to the ENTER_ROOM state</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">global</span> <span class="n">pub_move_base</span><span class="p">,</span> <span class="n">actual_pose</span><span class="p">,</span> <span class="n">places</span><span class="p">,</span> <span class="n">oracle</span>

        <span class="k">if</span> <span class="n">oracle</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">destination</span><span class="o">=</span><span class="n">places</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">destination</span><span class="o">=</span><span class="n">oracle_room</span>

        <span class="c1">## Initialize a MoveBaseActionGoal target to move my robot</span>
        <span class="n">move_goal</span> <span class="o">=</span> <span class="n">MoveBaseGoal</span><span class="p">()</span>
        <span class="n">move_goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span><span class="o">=</span><span class="s2">&quot;map&quot;</span>
        <span class="n">move_goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span><span class="o">=</span><span class="mi">1</span>
        <span class="n">move_goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">z</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">move_goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">move_goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span>

        <span class="n">move_goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">destination</span><span class="o">.</span><span class="n">x</span>
        <span class="n">move_goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">destination</span><span class="o">.</span><span class="n">y</span>
        <span class="n">move_goal</span><span class="o">.</span><span class="n">target_pose</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">pub_move_base</span><span class="o">.</span><span class="n">wait_for_server</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Moving from &quot;</span> <span class="o">+</span> <span class="n">actual_pose</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span> <span class="n">destination</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">pub_move_base</span><span class="o">.</span><span class="n">send_goal</span><span class="p">(</span><span class="n">move_goal</span><span class="p">)</span>
        <span class="n">pub_move_base</span><span class="o">.</span><span class="n">wait_for_result</span><span class="p">()</span>
        
        <span class="n">actual_pose</span><span class="o">.</span><span class="n">x</span><span class="o">=</span><span class="n">destination</span><span class="o">.</span><span class="n">x</span>
        <span class="n">actual_pose</span><span class="o">.</span><span class="n">y</span><span class="o">=</span><span class="n">destination</span><span class="o">.</span><span class="n">y</span>
        <span class="n">actual_pose</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">destination</span><span class="o">.</span><span class="n">name</span>


        <span class="c1"># If it is going to the oracle room it sets oracle to False for the future iterations of the state_machine, then returns &#39;solution&#39;</span>
        <span class="k">if</span> <span class="n">oracle</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">oracle</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">return</span> <span class="s1">&#39;solution&#39;</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

            <span class="k">return</span> <span class="s1">&#39;check_consistency&#39;</span></div></div>

<div class="viewcode-block" id="Check_Consistency"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Check_Consistency">[docs]</a><span class="k">class</span> <span class="nc">Check_Consistency</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A class to interact with the ARMOR ontology, asking for complete and consistent hypothesis as possible solutions</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;explore&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="Check_Consistency.execute"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Check_Consistency.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Description of the execute method:</span>
<span class="sd">        It checks if there are new IDs to try as a possible solution and in that case it sends them to the ontology_interface node, updates the ontology and then</span>
<span class="sd">        asks for complete and consistent hypothesis to use as a possible solution, then removes the inconsistent hypotheses (if any).</span>
<span class="sd">           </span>
<span class="sd">            Args:</span>
<span class="sd">                userdata to store the variables between the states </span>
<span class="sd">            </span>
<span class="sd">            Returns:</span>
<span class="sd">                &#39;explore&#39;(string): it must go to the MOVE state</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">global</span> <span class="n">IDs</span><span class="p">,</span> <span class="n">tried_IDs</span><span class="p">,</span> <span class="n">client_ID_msg</span><span class="p">,</span> <span class="n">oracle</span><span class="p">,</span> <span class="n">client_update_ontology</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">consistent_ids</span>

        <span class="c1">#Stop adding elements in the list</span>
        <span class="n">stop</span><span class="o">=</span><span class="kc">True</span>

        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">IDs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tried_IDs</span><span class="p">:</span>
                <span class="n">req</span><span class="o">=</span><span class="n">MarkerRequest</span><span class="p">()</span>
                <span class="n">req</span><span class="o">.</span><span class="n">markerId</span><span class="o">=</span><span class="nb">id</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="s1">&#39;/oracle_hint&#39;</span><span class="p">)</span>
                <span class="n">res</span><span class="o">=</span><span class="n">client_ID_msg</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reply: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
                <span class="n">oracle_hint</span><span class="o">=</span><span class="n">ErlOracle</span><span class="p">()</span>
                <span class="n">oracle_hint</span><span class="o">.</span><span class="n">ID</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">oracle_hint</span><span class="o">.</span><span class="n">ID</span>
                <span class="n">oracle_hint</span><span class="o">.</span><span class="n">key</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">oracle_hint</span><span class="o">.</span><span class="n">key</span>
                <span class="n">oracle_hint</span><span class="o">.</span><span class="n">value</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">oracle_hint</span><span class="o">.</span><span class="n">value</span>
                <span class="n">req</span><span class="o">=</span><span class="n">HintRequest</span><span class="p">()</span>
                <span class="n">req</span><span class="o">.</span><span class="n">oracle_hint</span><span class="o">=</span><span class="n">oracle_hint</span>
                <span class="n">client_add_hint</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
            
                <span class="n">tried_IDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

        <span class="c1">#After having added all the hints to the ontology_interface node, update the ontology performing &quot;reason&quot; operation</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">wait_for_service</span><span class="p">(</span><span class="s1">&#39;/ontology_interface/update_request&#39;</span><span class="p">)</span>
        <span class="n">client_update_ontology</span><span class="p">()</span>

        <span class="c1">#Clear ID list and update oracle flag to send robot in the oracle room to try a solution</span>
        <span class="n">IDs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1">#Ask for complete and consistent hypothesis as potential solutions</span>
        <span class="n">res</span><span class="o">=</span><span class="n">client_try_solution</span><span class="p">(</span><span class="n">ConsistentRequest</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">consistent</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">consistent_ids</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">consistent</span>
            <span class="n">oracle</span><span class="o">=</span><span class="kc">True</span>
        
        <span class="n">stop</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">return</span> <span class="s1">&#39;explore&#39;</span></div></div>


<div class="viewcode-block" id="Try_Solution"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Try_Solution">[docs]</a><span class="k">class</span> <span class="nc">Try_Solution</span><span class="p">(</span><span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A class to represent the behavior of the robot when it tries to generate a solution</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">smach</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                             <span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;explore&#39;</span><span class="p">,</span> <span class="s1">&#39;correct&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="Try_Solution.execute"><a class="viewcode-back" href="../../index.html#scripts.state_machine.Try_Solution.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">userdata</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Description of the execute method:</span>
<span class="sd">        It calls the /oracle_solution service to get the solution of the game, then it checks if one of the complete and consistent hypothesis </span>
<span class="sd">        corresponds to the solution. If it&#39;s correct it prints the solution associated to the ID, then the game ends, otherwise it</span>
<span class="sd">        returns to the MOVE state.</span>
<span class="sd">           </span>
<span class="sd">            Args:</span>
<span class="sd">                userdata to store the variables between the states (not utilized)</span>
<span class="sd">            </span>
<span class="sd">            Returns:</span>
<span class="sd">                &#39;explore&#39;(string): it must go to the MOVE state</span>
<span class="sd">                &#39;correct&#39;(string): the solution is correct and the state machine is stopped</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">global</span> <span class="n">consistent_ids</span>

        <span class="n">solution</span><span class="o">=</span><span class="n">ask_solution</span><span class="p">(</span><span class="n">OracleRequest</span><span class="p">())</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">consistent_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">solution</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Solution found!: &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">solution</span><span class="o">.</span><span class="n">ID</span><span class="p">))</span>

                <span class="n">req</span><span class="o">=</span><span class="n">SolutionRequest</span><span class="p">()</span>
                <span class="n">req</span><span class="o">.</span><span class="n">ID</span><span class="o">=</span><span class="nb">id</span>
                <span class="n">res</span><span class="o">=</span><span class="n">armor_solution</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Person: &quot;</span><span class="o">+</span><span class="n">res</span><span class="o">.</span><span class="n">person</span><span class="o">+</span><span class="s2">&quot; Weapon: &quot;</span><span class="o">+</span><span class="n">res</span><span class="o">.</span><span class="n">weapon</span><span class="o">+</span><span class="s2">&quot; Place: &quot;</span><span class="o">+</span><span class="n">res</span><span class="o">.</span><span class="n">place</span><span class="p">)</span>

                <span class="k">return</span> <span class="s1">&#39;correct&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solution ID &quot;</span><span class="o">+</span><span class="nb">id</span> <span class="o">+</span><span class="s2">&quot; is not correct&quot;</span><span class="p">)</span>

        <span class="n">consistent_ids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="s1">&#39;explore&#39;</span></div></div>

        


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../index.html#scripts.state_machine.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    It&#39;s the main of the state_machine node, it performs the initialization of the node itself and initializes all the services and subscribers.</span>
<span class="sd">    It also defines the SMACH state machine and runs it to start the simulation</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">global</span> <span class="n">pub_move_base</span><span class="p">,</span> <span class="n">sub_ID</span><span class="p">,</span> <span class="n">client_ID_msg</span><span class="p">,</span> <span class="n">client_add_hint</span><span class="p">,</span> <span class="n">client_update_ontology</span><span class="p">,</span> <span class="n">client_try_solution</span><span class="p">,</span> <span class="n">ask_solution</span>
    <span class="k">global</span> <span class="n">armor_solution</span>

    <span class="c1"># Initialize the node</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">init_node</span><span class="p">(</span><span class="s1">&#39;state_machine&#39;</span><span class="p">)</span>
 
    <span class="n">pub_move_base</span><span class="o">=</span><span class="n">actionlib</span><span class="o">.</span><span class="n">SimpleActionClient</span><span class="p">(</span><span class="s1">&#39;move_base&#39;</span><span class="p">,</span> <span class="n">MoveBaseAction</span><span class="p">)</span>
    <span class="n">sub_ID</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="s1">&#39;/marker_id&#39;</span><span class="p">,</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">IDs_callback</span><span class="p">)</span>
    <span class="n">client_ID_msg</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="s1">&#39;/oracle_hint&#39;</span><span class="p">,</span> <span class="n">Marker</span><span class="p">)</span>
    <span class="n">client_add_hint</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="s1">&#39;/ontology_interface/add_hint&#39;</span><span class="p">,</span> <span class="n">Hint</span><span class="p">)</span>
    <span class="n">client_update_ontology</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="s1">&#39;/ontology_interface/update_request&#39;</span><span class="p">,</span> <span class="n">Update</span><span class="p">)</span>
    <span class="n">client_try_solution</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="s1">&#39;/ontology_interface/check_consistency&#39;</span><span class="p">,</span> <span class="n">Consistent</span><span class="p">)</span>
    <span class="n">ask_solution</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="s1">&#39;/oracle_solution&#39;</span><span class="p">,</span> <span class="n">Oracle</span><span class="p">)</span>
    <span class="n">armor_solution</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">ServiceProxy</span><span class="p">(</span><span class="s1">&#39;/ontology_interface/ask_solution&#39;</span><span class="p">,</span> <span class="n">Solution</span><span class="p">)</span>

    <span class="n">init_scene</span><span class="p">()</span>

    <span class="c1"># Create a SMACH state machine</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="p">(</span><span class="n">outcomes</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;state_machine&#39;</span><span class="p">])</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">userdata</span><span class="o">.</span><span class="n">sm_counter</span> <span class="o">=</span> <span class="mi">0</span>


     <span class="c1"># Open the container</span>
    <span class="k">with</span> <span class="n">sm</span><span class="p">:</span>
        <span class="c1"># Add states to the container</span>
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;MOVE&#39;</span><span class="p">,</span> <span class="n">Explore</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;check_consistency&#39;</span><span class="p">:</span><span class="s1">&#39;CHECK_CONSISTENCY&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;solution&#39;</span><span class="p">:</span><span class="s1">&#39;SOLUTION&#39;</span> <span class="p">})</span>

        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;CHECK_CONSISTENCY&#39;</span><span class="p">,</span> <span class="n">Check_Consistency</span><span class="p">(),</span> 
                               <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;explore&#39;</span><span class="p">:</span><span class="s1">&#39;MOVE&#39;</span><span class="p">})</span>
        
        <span class="n">smach</span><span class="o">.</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;SOLUTION&#39;</span><span class="p">,</span> <span class="n">Try_Solution</span><span class="p">(),</span>
                                <span class="n">transitions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;explore&#39;</span><span class="p">:</span><span class="s1">&#39;MOVE&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;correct&#39;</span><span class="p">:</span><span class="s1">&#39;state_machine&#39;</span><span class="p">})</span>


    <span class="c1"># Create and start the introspection server for visualization</span>
    <span class="n">sis</span> <span class="o">=</span> <span class="n">smach_ros</span><span class="o">.</span><span class="n">IntrospectionServer</span><span class="p">(</span><span class="s1">&#39;server_name&#39;</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="s1">&#39;/SM_ROOT&#39;</span><span class="p">)</span>
    <span class="n">sis</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Execute the state machine</span>
    <span class="n">sm</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="c1"># Wait for ctrl-c to stop the application</span>
    <span class="n">rospy</span><span class="o">.</span><span class="n">spin</span><span class="p">()</span>
    <span class="n">sis</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>




<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Alessio Roda.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>